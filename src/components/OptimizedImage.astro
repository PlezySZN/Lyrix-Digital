---
/**
 * ═══════════════════════════════════════════════════════════
 * OPTIMIZED IMAGE — LYRIX OS
 *
 * Drop-in replacement for <img>. Uses Astro's astro:assets
 * pipeline for automatic WebP/AVIF conversion, srcset generation,
 * and proper loading/priority attributes for CWV.
 *
 * Usage:
 *   import heroImg from '../assets/hero.jpg';
 *   <OptimizedImage src={heroImg} alt="…" priority />
 *   <OptimizedImage src={heroImg} alt="…" />  ← lazy by default
 *
 * Remote images:
 *   <OptimizedImage src="https://…/photo.jpg" alt="…" width={800} height={600} />
 * ═══════════════════════════════════════════════════════════
 */

import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  /** Local import or remote URL */
  src: ImageMetadata | string;
  /** Required — accessibility is non-negotiable */
  alt: string;
  /** Mark as LCP element — sets eager loading + high fetchpriority */
  priority?: boolean;
  /** Override width (required for remote URLs) */
  width?: number;
  /** Override height (required for remote URLs) */
  height?: number;
  /** Quality 1-100 — defaults to 80 (sweet spot for size vs. fidelity) */
  quality?: number;
  /** Output format — let Astro auto-negotiate by default */
  format?: 'webp' | 'avif' | 'png' | 'jpeg';
  /** Additional CSS classes on the <img> */
  class?: string;
  /** Sizes attribute for responsive srcset */
  sizes?: string;
  /** Inline style object */
  style?: Record<string, string>;
}

const {
  src,
  alt,
  priority = false,
  width,
  height,
  quality = 80,
  format,
  class: className,
  sizes,
  style,
} = Astro.props;

// ─── Loading Strategy (CWV-critical) ───
// Above-the-fold (priority): eager + high fetchpriority + no decoding delay
// Below-the-fold (default): lazy + async decode → zero CLS, minimal LCP impact
const loading = priority ? 'eager' : 'lazy';
const fetchpriority = priority ? 'high' : undefined;
const decoding = priority ? 'sync' : 'async';
---

<Image
  src={src}
  alt={alt}
  width={width}
  height={height}
  quality={quality}
  format={format}
  loading={loading}
  decoding={decoding}
  fetchpriority={fetchpriority}
  sizes={sizes}
  class={className}
  style={style}
/>
