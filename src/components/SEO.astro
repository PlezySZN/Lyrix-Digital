---
/**
 * ═══════════════════════════════════════════════════════════
 * SEO.astro — THE LYRIX DIGITAL "SET IT AND FORGET IT" SEO ENGINE
 *
 * Drop this once inside <head> and never think about SEO markup again.
 * Handles: meta tags, canonical, hreflang, Open Graph, Twitter/X Cards,
 * JSON-LD structured data (Organization, WebSite, Service, Article,
 * FAQ, BreadcrumbList), preconnect hints, and robots directives.
 *
 * Usage:
 *   <SEO lang={lang} />                         ← home page (defaults)
 *   <SEO lang={lang} title="…" description="…" /> ← custom page
 *   <SEO lang={lang} article={articleData} />    ← blog/article page
 * ═══════════════════════════════════════════════════════════
 */

import { t } from '../i18n/utils';
import type { Lang } from '../i18n/ui';

/* ─── TypeScript Interfaces ───────────────────────────── */

/** Article-specific structured data — pass this for blog/article pages */
interface ArticleData {
  /** Article headline */
  headline: string;
  /** ISO 8601 date — e.g. "2026-02-08" */
  datePublished: string;
  /** ISO 8601 date (optional — omit if unpublished update) */
  dateModified?: string;
  /** Author display name */
  author: string;
  /** Optional author URL */
  authorUrl?: string;
  /** Article category / section */
  section?: string;
  /** Article tags for keyword signals */
  tags?: string[];
  /** Article body word count (helps Google assess depth) */
  wordCount?: number;
}

/** Breadcrumb item for BreadcrumbList schema */
interface BreadcrumbItem {
  name: string;
  url: string;
}

interface Props {
  /** Current language — drives all i18n logic */
  lang: Lang;
  /** Page title — falls back to i18n meta.title */
  title?: string;
  /** Page description — falls back to i18n meta.description */
  description?: string;
  /** Comma-separated keywords (optional — low direct SEO weight but still indexes) */
  keywords?: string;
  /** OG image path relative to site root — defaults to /og-image.png */
  image?: string;
  /** Override the OG image alt text */
  imageAlt?: string;
  /** Override the canonical path (defaults to Astro.url.pathname) */
  canonicalPath?: string;
  /** Page type — controls which JSON-LD schema is emitted */
  type?: 'website' | 'article' | 'service';
  /** Article-specific data — required when type="article" */
  article?: ArticleData;
  /** Custom breadcrumb trail — auto-generated if omitted */
  breadcrumbs?: BreadcrumbItem[];
  /** Disable FAQ schema injection (auto-injected on home page only) */
  noFaq?: boolean;
  /** Override robots directive — defaults to full index */
  robots?: string;
}

/* ─── Constants ───────────────────────────────────────── */

const SITE = 'https://lyrixdigital.com';
const BRAND = 'Lyrix Digital';
const DEFAULT_OG_IMAGE = 'public/og-image.png';
const THEME_COLOR = '#050505';

/* ─── Destructure Props With Defaults ─────────────────── */

const {
  lang,
  title,
  description,
  keywords,
  image,
  imageAlt,
  canonicalPath,
  type = 'website',
  article,
  breadcrumbs,
  noFaq = false,
  robots,
} = Astro.props;

/* ─── Resolved Values (graceful fallbacks) ────────────── */

const resolvedTitle       = title       ?? t(lang, 'meta.title');
const resolvedDescription = description ?? t(lang, 'meta.description');
const resolvedImage       = image       ?? DEFAULT_OG_IMAGE;
const resolvedImageAlt    = imageAlt    ?? resolvedTitle;
const resolvedRobots      = robots      ?? 'index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1';

// Canonical URL
const currentPath  = canonicalPath ?? Astro.url.pathname;
const canonicalUrl = new URL(currentPath, SITE).href;

// Full image URL
const imageUrl = new URL(resolvedImage, SITE).href;

// Open Graph locale mapping
const ogLocale    = lang === 'es' ? 'es_PR' : 'en_US';
const ogLocaleAlt = lang === 'es' ? 'en_US' : 'es_PR';
const inLanguage  = lang === 'es' ? 'es-PR' : 'en-US';

// OG type (articles need "article" not "website")
const ogType = type === 'article' ? 'article' : 'website';

/* ─── Hreflang Alternates ─────────────────────────────── */

const hreflangs = [
  { lang: 'en', href: new URL(currentPath.replace(`/${lang}/`, '/en/'), SITE).href },
  { lang: 'es', href: new URL(currentPath.replace(`/${lang}/`, '/es/'), SITE).href },
];
// x-default → English variant (matches defaultLocale in astro.config)
const xDefaultHref = hreflangs.find(h => h.lang === 'en')!.href;

/* ─── Determine if Home Page (for conditional schemas) ── */

const isHomePage = /^\/(en|es)\/?$/.test(currentPath);

/* ─── Breadcrumb Generation ───────────────────────────── */

const resolvedBreadcrumbs: BreadcrumbItem[] = breadcrumbs ?? [
  {
    name: lang === 'es' ? 'Inicio' : 'Home',
    url: `${SITE}/${lang}/`,
  },
];

/* ═══════════════════════════════════════════════════════════
   JSON-LD STRUCTURED DATA GENERATION
   Uses Google's @graph pattern for efficient parsing.
═══════════════════════════════════════════════════════════ */

// ── 1. Organization (always present)
const OG_IMAGE_URL = `${SITE}public/og-image.png`;

const organizationSchema = {
  '@type': 'Organization',
  '@id': `${SITE}/#organization`,
  name: BRAND,
  url: SITE,
  logo: {
    '@type': 'ImageObject',
    '@id': `${SITE}/#logo`,
    url: OG_IMAGE_URL,
    contentUrl: OG_IMAGE_URL,
    width: 1200,
    height: 630,
    caption: BRAND,
  },
  image: { '@id': `${SITE}/#logo` },
  description: 'Premium Web Design Agency in Puerto Rico — Desarrollo Web, Cinematic Media & Digital Marketing for high-end contractors and professionals.',
  areaServed: [
    { '@type': 'City', name: 'San Juan' },
    { '@type': 'City', name: 'Dorado' },
    { '@type': 'AdministrativeArea', name: 'Puerto Rico' },
    { '@type': 'City', name: 'Miami' },
  ],
  knowsLanguage: ['es', 'en'],
  sameAs: [
    // Add social profiles here when available:
    // 'https://www.instagram.com/lyrixdigital',
    // 'https://www.linkedin.com/company/lyrixdigital',
  ],
};

// ── 2. WebSite (enables sitelinks search)
const websiteSchema = {
  '@type': 'WebSite',
  '@id': `${SITE}/#website`,
  name: BRAND,
  url: SITE,
  inLanguage,
  publisher: { '@id': `${SITE}/#organization` },
};

// ── 3. WebPage (every page gets this)
const webPageSchema: Record<string, unknown> = {
  '@type': type === 'article' ? 'Article' : 'WebPage',
  '@id': `${canonicalUrl}#webpage`,
  url: canonicalUrl,
  name: resolvedTitle,
  description: resolvedDescription,
  inLanguage,
  isPartOf: { '@id': `${SITE}/#website` },
  breadcrumb: { '@id': `${canonicalUrl}#breadcrumb` },
  ...(type === 'article' && article ? {
    headline: article.headline,
    datePublished: article.datePublished,
    ...(article.dateModified && { dateModified: article.dateModified }),
    ...(article.wordCount && { wordCount: article.wordCount }),
    ...(article.section && { articleSection: article.section }),
    ...(article.tags && { keywords: article.tags.join(', ') }),
    author: {
      '@type': 'Person',
      name: article.author,
      ...(article.authorUrl && { url: article.authorUrl }),
    },
    image: imageUrl,
    publisher: { '@id': `${SITE}/#organization` },
  } : {}),
};

// ── 4. ProfessionalService + LocalBusiness (home page & service pages)
// Dual @type maximizes schema coverage for local SEO + professional service rich results.
const serviceSchema = (type === 'service' || isHomePage) ? {
  '@type': ['ProfessionalService', 'LocalBusiness'],
  '@id': `${SITE}/#service`,
  name: BRAND,
  url: SITE,
  description: lang === 'es'
    ? 'Agencia Premium de Desarrollo Web en Puerto Rico. Diseño Web de alto calibre, Cinematic Media, SEO y Marketing Digital para contratistas y profesionales.'
    : 'Premium Web Design Agency in Puerto Rico. High-end Desarrollo Web, Cinematic Media, SEO & Digital Marketing for contractors and professionals.',
  priceRange: '$$$',
  image: OG_IMAGE_URL,
  logo: { '@id': `${SITE}/#logo` },
  telephone: '+1-787-664-4109',
  email: 'lyrixdigitals@gmail.com',
  address: {
    '@type': 'PostalAddress',
    addressLocality: 'San Juan',
    addressRegion: 'PR',
    addressCountry: 'US',
  },
  geo: {
    '@type': 'GeoCoordinates',
    latitude: 18.4655,
    longitude: -66.1057,
  },
  areaServed: [
    { '@type': 'City', name: 'San Juan' },
    { '@type': 'City', name: 'Dorado' },
    { '@type': 'AdministrativeArea', name: 'Puerto Rico' },
    { '@type': 'City', name: 'Miami' },
  ],
  serviceType: [
    'Web Design',
    'Web Development',
    'Desarrollo Web',
    'Cinematic Media',
    'Video Production',
    'SEO',
    'Digital Marketing',
  ],
  knowsLanguage: ['es', 'en'],
  hasOfferCatalog: {
    '@type': 'OfferCatalog',
    name: lang === 'es' ? 'Servicios Digitales Premium' : 'Premium Digital Services',
    itemListElement: [
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: lang === 'es' ? 'Diseño y Desarrollo Web Premium' : 'Premium Web Design & Development',
          description: lang === 'es'
            ? 'Sitios web de alto rendimiento para contratistas y profesionales en Puerto Rico.'
            : 'High-performance websites for contractors and professionals in Puerto Rico.',
        },
      },
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: lang === 'es' ? 'Producción Cinematográfica' : 'Cinematic Media Production',
          description: lang === 'es'
            ? 'Video 4K con drone, edición profesional y contenido para redes sociales.'
            : '4K drone video, professional editing & social media content.',
        },
      },
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: lang === 'es' ? 'SEO y Marketing Digital' : 'SEO & Digital Marketing',
          description: lang === 'es'
            ? 'Posicionamiento en buscadores y estrategia digital para el mercado de Puerto Rico.'
            : 'Search engine optimization and digital strategy for the Puerto Rico market.',
        },
      },
    ],
  },
} : null;

// ── 5. BreadcrumbList
const breadcrumbSchema = {
  '@type': 'BreadcrumbList',
  '@id': `${canonicalUrl}#breadcrumb`,
  itemListElement: resolvedBreadcrumbs.map((crumb, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    name: crumb.name,
    item: crumb.url,
  })),
};

// ── 6. FAQPage (home page only, unless explicitly disabled)
const faqIds = [1, 2, 3, 4, 5, 6, 7, 8] as const;
const faqSchema = (isHomePage && !noFaq) ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqIds.map((n) => ({
    '@type': 'Question',
    name: t(lang, `kb.q${n}.question` as any),
    acceptedAnswer: {
      '@type': 'Answer',
      text: t(lang, `kb.q${n}.answer` as any),
    },
  })),
} : null;

// ── Assemble @graph payload
const graphNodes = [
  organizationSchema,
  websiteSchema,
  webPageSchema,
  breadcrumbSchema,
  ...(serviceSchema ? [serviceSchema] : []),
].filter(Boolean);

const graphPayload = {
  '@context': 'https://schema.org',
  '@graph': graphNodes,
};
---

<!-- ═══════════════════════════════════════════════════════════
     SEO.astro — GENERATED <head> TAGS
     Do not add duplicate meta/canonical/OG manually.
═══════════════════════════════════════════════════════════ -->

<!-- ═══ CANONICAL ═══ -->
<link rel="canonical" href={canonicalUrl} />

<!-- ═══ HREFLANG ALTERNATES ═══ -->
{hreflangs.map(({ lang: hl, href }) => (
  <link rel="alternate" hrefLang={hl} href={href} />
))}
<link rel="alternate" hrefLang="x-default" href={xDefaultHref} />

<!-- ═══ KEYWORDS (optional) ═══ -->
{keywords && <meta name="keywords" content={keywords} />}

<!-- ═══ OPEN GRAPH ═══ -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={resolvedTitle} />
<meta property="og:description" content={resolvedDescription} />
<meta property="og:image" content={imageUrl} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={resolvedImageAlt} />
<meta property="og:locale" content={ogLocale} />
<meta property="og:locale:alternate" content={ogLocaleAlt} />
<meta property="og:site_name" content={BRAND} />

<!-- ═══ OPEN GRAPH: ARTICLE (only when type="article") ═══ -->
{type === 'article' && article && (
  <>
    <meta property="article:published_time" content={article.datePublished} />
    {article.dateModified && <meta property="article:modified_time" content={article.dateModified} />}
    {article.section && <meta property="article:section" content={article.section} />}
    {article.tags?.map(tag => <meta property="article:tag" content={tag} />)}
    <meta property="article:author" content={article.author} />
  </>
)}

<!-- ═══ TWITTER / X CARD ═══ -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={resolvedTitle} />
<meta name="twitter:description" content={resolvedDescription} />
<meta name="twitter:image" content={imageUrl} />
<meta name="twitter:image:alt" content={resolvedImageAlt} />

<!-- ═══ THEME & COLOR SCHEME ═══ -->
<meta name="theme-color" content={THEME_COLOR} />
<meta name="color-scheme" content="dark" />

<!-- ═══ PRECONNECT HINTS (CWV: eliminates DNS/TLS latency for fonts) ═══ -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />

<!-- ═══ ROBOTS & CRAWL DIRECTIVES ═══ -->
<meta name="robots" content={resolvedRobots} />
<meta name="author" content={BRAND} />
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- ═══ JSON-LD: MAIN SCHEMA GRAPH ═══ -->
<Fragment set:html={`<script type="application/ld+json">${JSON.stringify(graphPayload)}</script>`} />

<!-- ═══ JSON-LD: FAQ (standalone — Google prefers separate for rich results) ═══ -->
{faqSchema && (
  <Fragment set:html={`<script type="application/ld+json">${JSON.stringify(faqSchema)}</script>`} />
)}
